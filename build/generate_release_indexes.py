#!/usr/bin/python
#
# Copyright 2020 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

"""Generates jax_releases.html and libtpu_releases.html package indexes.

To update public copies, use:
gsutil cp jax_releases.html gs://jax-releases/
gsutil cp libtpu_releases.html gs://jax-releases/
"""

import subprocess

JAXLIB_INDEX_FILENAME = "jax_releases.html"
LIBTPU_INDEX_FILENAME = "libtpu_releases.html"

HEADER = """
<!-- Generated by jax/build/generate_release_index.py, do not update manually! -->
<html>
<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></head>
<body>
"""

FOOTER = "</body>\n</html>\n"

def get_entries(gcs_uri, whl_filter=".whl"):
  entries = []
  print(f"Running command: gsutil ls {gcs_uri}")
  ls_output = subprocess.check_output(["gsutil", "ls", gcs_uri])
  for line in ls_output.decode("utf-8").split("\n"):
    # Skip incorrectly formatted wheel filenames and other gsutil output
    if whl_filter not in line: continue
    # Example lines:
    #  gs://jax-releases/cuda101/jaxlib-0.1.52+cuda101-cp38-none-manylinux2010_x86_64.whl
    #  gs://cloud-tpu-tpuvm-artifacts/wheels/libtpu-nightly/libtpu_nightly-0.1.dev20210615-py3-none-any.whl

    # Link title should be the innermost directory + wheel filename
    # Example link titles:
    #  cuda101/jaxlib-0.1.52+cuda101-cp38-none-manylinux2010_x86_64.whl
    #  libtpu-nightly/libtpu_nightly-0.1.dev20210615-py3-none-any.whl
    link_title_idx = line.rfind('/', 0, line.rfind('/')) + 1
    link_title = line[link_title_idx:]
    link_href = line.replace("gs://", "https://storage.googleapis.com/")
    entries.append(f'<a href="{link_href}">{link_title}</a><br>\n')
  return entries

def write_release_index(filename, entries):
  print(f"Writing index to {filename}")
  with open(filename, "w") as f:
    f.write(HEADER)
    for entry in entries:
      f.write(entry)
    f.write(FOOTER)
  print("Done.")

jaxlib_cuda_entries = get_entries("gs://jax-releases/cuda*", whl_filter="+cuda")
jaxlib_nocuda_entries = get_entries("gs://jax-releases/nocuda")
libtpu_entries = get_entries("gs://cloud-tpu-tpuvm-artifacts/wheels/libtpu-nightly/")

write_release_index(JAXLIB_INDEX_FILENAME,
                    jaxlib_cuda_entries + jaxlib_nocuda_entries)
write_release_index(LIBTPU_INDEX_FILENAME, libtpu_entries)
